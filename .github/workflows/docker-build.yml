name: Docker Build and Test

on:
  workflow_dispatch:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    name: Build and Test All Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build all Docker images
        run: |
          docker-compose build --parallel

      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to initialize..."
          sleep 30

      - name: Verify services are running
        run: |
          docker-compose ps

      - name: Test MySQL connection
        run: |
          docker-compose exec -T mysql mysql -u mern_user -pmern_password -e "SELECT 1" mern_db

      - name: Test Backend API
        run: |
          echo "Testing backend health endpoint..."
          curl -f http://localhost:5000/api/health || exit 1
          
          echo "Testing users endpoint..."
          curl -f http://localhost:5000/api/users || exit 1
          
          echo "Testing posts endpoint..."
          curl -f http://localhost:5000/api/posts || exit 1

      - name: Test database queries
        run: |
          echo "Testing user count..."
          USER_COUNT=$(docker-compose exec -T mysql mysql -u mern_user -pmern_password -sN -e "SELECT COUNT(*) FROM users" mern_db)
          echo "Found $USER_COUNT users"
          
          echo "Testing post count..."
          POST_COUNT=$(docker-compose exec -T mysql mysql -u mern_user -pmern_password -sN -e "SELECT COUNT(*) FROM posts" mern_db)
          echo "Found $POST_COUNT posts"

      - name: Cleanup
        if: always()
        run: |
          docker-compose down -v
