name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Backend Tests and Build
  backend:
    name: Backend - Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache backend node modules
        uses: actions/cache@v3
        with:
          path: backend/node_modules
          key: ${{ runner.os }}-node-backend-${{ hashFiles('backend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-backend-

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install

      - name: Run backend linting (if available)
        working-directory: ./backend
        run: |
          if [ -f "package.json" ] && grep -q "\"lint\"" package.json; then
            npm run lint || true
          else
            echo "No lint script found, skipping..."
          fi

      - name: Run backend tests (if available)
        working-directory: ./backend
        run: |
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test || true
          else
            echo "No test script found, skipping..."
          fi

      - name: Build backend Docker image
        working-directory: ./backend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest .

  # Frontend Tests and Build
  frontend:
    name: Frontend - Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache frontend node modules
        uses: actions/cache@v3
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-frontend-${{ hashFiles('frontend/package.json') }}
          restore-keys: |
            ${{ runner.os }}-node-frontend-

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      - name: Run frontend linting (if available)
        working-directory: ./frontend
        run: |
          if [ -f "package.json" ] && grep -q "\"lint\"" package.json; then
            npm run lint || true
          else
            echo "No lint script found, skipping..."
          fi

      - name: Run frontend tests (if available)
        working-directory: ./frontend
        run: |
          if [ -f "package.json" ] && grep -q "\"test\"" package.json; then
            npm test -- --watchAll=false || true
          else
            echo "No test script found, skipping..."
          fi

      - name: Build frontend Docker image
        working-directory: ./frontend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .

  # Docker Compose Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build services with Docker Compose
        run: |
          docker-compose build

      - name: Start services
        run: |
          docker-compose up -d
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Check MySQL health
        run: |
          docker-compose exec -T mysql mysqladmin ping -h localhost || exit 1

      - name: Check backend health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:5000/api/health; then
              echo "Backend is healthy"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend health check failed"
          exit 1

      - name: Test API endpoints
        run: |
          # Test health endpoint
          curl -f http://localhost:5000/api/health || exit 1
          
          # Test users endpoint
          curl -f http://localhost:5000/api/users || exit 1
          
          # Test posts endpoint
          curl -f http://localhost:5000/api/posts || exit 1
          
          echo "All API endpoints are working"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker-compose logs backend
          echo "=== Frontend Logs ==="
          docker-compose logs frontend
          echo "=== MySQL Logs ==="
          docker-compose logs mysql

      - name: Stop services
        if: always()
        run: |
          docker-compose down -v

  # Push to GitHub Container Registry (only on main/master)
  push-images:
    name: Push Docker Images
    runs-on: ubuntu-latest
    needs: [backend, frontend, integration-tests]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        working-directory: ./backend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest

      - name: Build and push frontend image
        working-directory: ./frontend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
